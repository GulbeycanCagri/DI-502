<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chatbot</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --chat-bg: #ffffff;
            --text-color: #050505;
            --border-color: #d1d1d1;
            --input-bg: #f0f2f5;
            --user-bubble-bg: #0084ff;
            --user-bubble-text: #ffffff;
            --bot-bubble-bg: #e4e6eb;
            --bot-bubble-text: #050505;
            --link-color: #0084ff;
            --icon-color: #65676b;
        }

        body.dark-mode {
            --bg-color: #18191a;
            --sidebar-bg: #242526;
            --chat-bg: #242526;
            --text-color: #e4e6eb;
            --border-color: #3a3b3c;
            --input-bg: #3a3b3c;
            --user-bubble-bg: #0084ff;
            --user-bubble-text: #ffffff;
            --bot-bubble-bg: #3a3b3c;
            --bot-bubble-text: #e4e6eb;
            --link-color: #2374e1;
            --icon-color: #b0b3b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #sidebar h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        #sidebar .chat-history {
            color: var(--icon-color);
            font-style: italic;
        }

        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg);
        }

        #chat-header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #chat-header h1 {
            font-size: 1.5rem;
        }

        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
        }
        input:checked + .slider {
            background-color: var(--link-color);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        #chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .user-message {
            background-color: var(--user-bubble-bg);
            color: var(--user-bubble-text);
            align-self: flex-end;
        }

        .bot-message {
            background-color: var(--bot-bubble-bg);
            color: var(--bot-bubble-text);
            align-self: flex-start;
        }
        
        .bot-message.loading {
            display: flex;
            align-items: center;
        }

        .bot-message.loading span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: var(--icon-color);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .bot-message.loading span:nth-child(1) { animation-delay: -0.32s; }
        .bot-message.loading span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        #chat-form {
            display: flex;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        #chat-form input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 12px;
            border-radius: 18px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
        }
        
        #chat-form input[type="text"]:focus {
            outline: none;
        }

        #chat-form button, #chat-form label {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 15px;
            color: var(--icon-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #chat-form button:hover, #chat-form label:hover {
            color: var(--link-color);
        }

        #chat-form svg {
            width: 24px;
            height: 24px;
        }
        
        #document-name {
            font-style: italic;
            font-size: 0.8rem;
            color: var(--icon-color);
            margin-left: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>

    <aside id="sidebar">
        <h2>Chat History</h2>
        <p class="chat-history">(Future chat history will be listed here)</p>
    </aside>

    <main id="chat-container">
        <header id="chat-header">
            <h1>RAG Chatbot</h1>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="checkbox">
                    <input type="checkbox" id="checkbox" />
                    <div class="slider round"></div>
                </label>
            </div>
        </header>

        <div id="chat-messages">
             <div class="message bot-message">
                Hello! Please upload a PDF, TXT, or MD file and ask me a question about it.
            </div>
        </div>

        <form id="chat-form">
            <label for="document-upload" title="Upload Document">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                </svg>
            </label>
            <input type="file" id="document-upload" name="document" accept=".pdf,.txt,.md">
            <div id="online-research-wrapper" title="Online Research">
                <input type="checkbox" id="online-research">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0M2.04 4.326c.325 1.329 2.532 2.54 3.717 3.19.48.263.793.434.743.484q-.086.086-.56.342c-1.433.747-4.005 1.226-4.005 1.226s.275-1.606 1.158-3.253c.81-1.523 2.478-2.543 3.52-3.003.413-.18.74-.303.74-.303s-1.335.08-2.462.456a4.9 4.9 0 0 0-1.618.98zM12.96 11.674c-.325-1.329-2.532-2.54-3.717-3.19-.48-.263-.793-.434-.743-.484q.086-.086.56-.342c1.433-.747 4.005-1.226 4.005-1.226s-.275 1.606-1.158 3.253c-.81-1.523-2.478 2.543-3.52 3.003-.413-.18-.74-.303-.74-.303s1.335-.08 2.462-.456a4.9 4.9 0 0 0 1.618-.98z"/>
                </svg>
            </div>
            <input type="text" id="question-input" name="question" placeholder="Ask a question..." autocomplete="off">
            <span id="document-name"></span>
            <button type="submit" title="Send">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                </svg>
            </button>
        </form>
    </main>

    <script>
        const chatForm = document.getElementById('chat-form');
        const questionInput = document.getElementById('question-input');
        const documentInput = document.getElementById('document-upload');
        const documentNameSpan = document.getElementById('document-name');
        const chatMessages = document.getElementById('chat-messages');
        const onlineResearchCheckbox = document.getElementById('online-research');

        // --- Dark Mode ---
        const themeSwitch = document.getElementById('checkbox');
        themeSwitch.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // Load theme from local storage
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeSwitch.checked = true;
        }

        // --- File Name Display ---
        documentInput.addEventListener('change', () => {
            if (documentInput.files.length > 0) {
                documentNameSpan.textContent = documentInput.files[0].name;
            } else {
                documentNameSpan.textContent = '';
            }
        });

        // --- Chat Logic ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = questionInput.value.trim();
            const documentFile = documentInput.files[0];
            const useOnlineResearch = onlineResearchCheckbox.checked;

            if (!question) {
                addMessage("Please enter a question.", "bot");
                return;
            }
            
            // Clear file input if online research is checked
            if (useOnlineResearch) {
                documentInput.value = ""; // Clear file selection
                documentNameSpan.textContent = '';
            }

            // Plain chat mode if no file and no online research
            if (!documentFile && !useOnlineResearch) {
                addMessage(question, "user");
                questionInput.value = '';
                const loadingMessageId = addLoadingMessage();
                
                const formData = new FormData();
                formData.append('question', question);
                
                await sendRequest(formData, loadingMessageId);
                return;
            }

            addMessage(question, "user");
            questionInput.value = '';
            const loadingMessageId = addLoadingMessage();

            const formData = new FormData();
            formData.append('question', question);
            if (documentFile) {
                formData.append('document', documentFile);
            }
            if (useOnlineResearch) {
                formData.append('online_research', 'true');
            }
            
            await sendRequest(formData, loadingMessageId);
        });

        async function sendRequest(formData, loadingMessageId) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                let answer = "Sorry, something went wrong.";
                if (response.ok) {
                    answer = data.answer;
                } else {
                    answer = data.error || answer;
                }
                updateMessage(loadingMessageId, answer);

            } catch (error) {
                console.error('Error:', error);
                updateMessage(loadingMessageId, "Failed to connect to the server.");
            }
        }

        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingMessage() {
            const messageId = `msg-${Date.now()}`;
            const messageElement = document.createElement('div');
            messageElement.id = messageId;
            messageElement.classList.add('message', 'bot-message', 'loading');
            messageElement.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageId;
        }

        function updateMessage(messageId, newText) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.classList.remove('loading');
                messageElement.innerHTML = ''; // Clear loading dots
                messageElement.textContent = newText;
            }
        }
    </script>
</body>
</html>